---
title: Что такое транспиляция?
subtitle:
description: Базовые понятия о транспиляции, разбор проблем, которые она решает и краткий обзор ее реализаций.
image: "assets/images/transpilers/cover.png"
author: Казанцев Игорь
---

Понять, что такое транспилеры и какова их роль в программировании, просто на близком многим примере. Представим, что у вас есть зарядное устройство, которое берет энергию из воздуха, заряжает все устройства за 42 секунды, но есть проблема — коннектор этого устройства рассчитан только на один тип разъемов. Решение данного неудобства напрашивается само собой, найти такой же волшебный и универсальный переходник, который можно подключать с одной стороны к зарядному устройству, а с другой — к нужному девайсу.

Схожую проблему решают транспилеры, они преобразуют один, удобный для нас, код в другой, который может применяться и работать у конечного пользователя и образует связь между ними. Эта связь может быть как между разными языками одного уровня абстракции, так и между разными версиями одного языка.

**Транспиляция** — преобразование программы, при котором используется исходный код программы, написанной на одном языке программирования в качестве исходных данных, и производится эквивалентный исходный код на другом языке программирования того же уровня абстракции.

## Когда нужна транспиляция?

Рассмотрим два случая, в которых использование транспилеров окажется очень полезным.

Представим ситуацию, когда мы решили создать новый стартап по продаже переходников для супер зарядок, и нам нужно веб-приложение для удобного взаимодействия с клиентами. Мы берем JavaScript последней версии, с помощью которого мы можем реализовать все, что задумали. Но, к сожалению, не все браузеры в последних обновлениях поддержали новую версию нашего языка, что еще хуже, не все пользователи обновляют свои браузеры. На помощь приходят транспилеры, которые преобразуют наш JS код в JS код более старых версий, и каждый пользователь сможет пользоваться удобным ему браузером, а мы сможем писать код, используя комфортные для нас инструменты.

С ростом приложения может появиться необходимость добавить типизацию в проект, для повышения надежности и качества кода. В ход пойдет TypeScript - типизированный JavaScript, который добавляет в обычный JS всю мощь типизации. И вновь возникнет проблема, браузеры умеют работать только со стандартным JavaScript, и наш код не запустится ни в одном браузере. Аналогично первому случаю, нам на помощь придет транспилер TypeScript.

## Как используют транспилеры?

Тринспилеры нашли широкое применение во многих областях программирования, в общем случае можем выделить 2 цели их использования, которые вытекают из определения:

- Транспиляция одной версии языка в другую. Так как языки программирования не статические структуры и постоянно обновляются и улучшается, возникают ситуации, когда разработчик уже пишет на новой версии языка, а среда, где код используется, поддерживает и работает только с предыдущими версиями. Например, для переходов между версиями стандарта ECMAScript используется Babel. Так же возможно и преобразование в другую сторону, когда необходимо перевести проект на более новую версию языка, а делать вручную это долго и больно. Например, для транспиляции кода на Python 2.x в код на Python 3 есть 2to3

- Транспиляция между разными языками. Бывает, что конечная среда поддерживает один язык, а вести разработку, по тем или иным причинам, удобнее вести на другом, тут возникает необходимость трансформации “удобного” языка в тот, который требуется. Например, исходный язык может поддерживать уникальные функции, необходимые для разработки. По этой причине используется TypeScript, а затем транспилируется в JS

## Как работают транспилеры?

В качестве примера рассмотрим работу выдуманного транспилера над возведением в квадрат на JS:

```
a ** b
```

в такое же возведение в квадрат, но с помощью встроенного объекта Math:

```
Math.pow(a, b)
```

### Парсинг исходного кода в абстрактное синтаксическое дерево (AST)

При парсинге транспилер берет сырой код и создаёт его более абстрактное представление.

В общем случае, парсинг делится на два этапа: лексический анализ и синтаксический анализ.

- Лексический анализ берёт "сырой" код и разбивает его на части (токены) с помощью токенизера (или лексера). Токены — это массив маленьких объектов, которые описывают изолированный кусок кода. Это могут быть цифры, пунктуация, метки, операторы, всё что угодно. В нашем случае токенами будут унарный оператор и его операнды:

![transpilers, tokens](/assets/images/transpilers/tokens.png)

- Синтаксический анализ берёт токены и строит представление, которое описывает все части синтаксиса и их связи между собой. Это называется промежуточным представлением или AST (Abstract Syntax Tree, Абстрактное Синтаксическое Дерево). Если кратко, то Abstract Syntax Tree (AST) — это глубоко вложенные объекты, представленные таким образом, чтобы с ними было легко работать, и при этом предоставляющие много информации. Преобразуем наши токены в AST. Оператор возведения в квадрат будет являться бинарным выражением (в нашем случае единственным) внутри программы, а операнды станут идентификаторами в этом выражении:

![transpilers, AST](/assets/images/transpilers/AST.png)

### Трансформация AST

После парсинга происходит трансформация, которая производит все необходимые для дальнейшей работы изменения в абстрактном представлении.

Здесь берётся AST с прошлого шага и потом изменяется. Трансформация может изменять его в рамках того же языка, или же транслировать его в другой. Давайте посмотрим, как мы будем трансформировать AST. Оператор умножения заменяется на вызов выражения, при этом его операнды становятся аргументами выражения (Math.pow).

![transpilers, transformedAST](/assets/images/transpilers/transformed_AST.png)

### Генерация конечного кода

Когда все изменения сделаны, транспилер берёт трансформированное представление кода и на его основе генерирует новый код, который соответствует AST. В нашем случае транспилятор преобразует дерево из прошлого шага и вернет конечный код, который можно использовать по месту назначения.

![transpilers, generate](/assets/images/transpilers/generate_result.png)

В итоге код из начального состояния проходит ряд преобразований (парсинг -> трансформация -> генерация) до конечного состояния - этот процесс и называется транспиляцией.

### Обратная связь

Использование транспилеров затрудняет пошаговую отладку, когда нам нужно найти точное место поломки в исходном коде по коду конечному. В таких случаях используются различные утилиты, позволяющие сопоставить результат транспиляции с оригинальным кодом. Для JS есть утилита SourceMap, которая в процессе создания конечного кода создает файл-маппер, по которому можно связать исходный и конечный код.

## Инструменты(реализации) транспиляции кода

В рамках Front-end разработки транспилеры нужны например для:

- преобразования JSX-кода в JavaScript при разработке на React
- трансформации LESS/SCSS в CSS при использовании CSS препроцессоров
- транспиляции TypeScript в JS, когда мы хотим использовать мощь типизации

Большое количество ситуаций, когда может пригодиться странспиляция, вызывает неудобства, если для каждой из них использовать отдельный инструмент. Но есть инструмент для JS, который решает множество проблем — Babel.

Babel — это транспилер, чаще всего используется для трансформации новых версий стандарта ECMAScript в код, который могут обработать как современные, так и не самые новые браузеры и другие среды, в которых может выполняться JavaScript. На этом его функции не заканчиваются, так как он также может выполнять все операции из примеров выше и многое другое.

Также популярными являются транспилеры, трансформирующие один язык программирования в другой или другие, например:

- Vala, состоящий из двух языков: Vala и Genie, транслирующих самый обычный код на С
- Haxe создавался одновременно с Vala, но предназначен для транспилирования во Flash, JavaScript и Neko. Со временем Haxe разросся до мощного набора инструментов, поддерживающих транскомпиляцию на разные языки и платформы, включая JavaScript, C++, C#, Java, JVM, Python, Lua, PHP и Flash.
- Lombok — интересное решение для тех, кому не нравится Java, или не нравится ничего, кроме Java. Это плагин компилятора, добавляющий в Java новые «ключевые слова» и превращающий аннотации в Java-код, сокращая усилия на разработку и обеспечивая дополнительную функциональность. Например, он позволяет в обычном коде на Java использовать ключевое слово val (аналог var из C#).
- Bridge.NET позволяет использовать в JavaScript производительность C#, а также мощные VisualStudio IDE и стандартные инструменты .NET (такие как msbuild, рефакторинг, модульное тестирование, статический анализ, визуализация кода, FxCop).
- Grumpy обеспечивает трансляцию кода на языке Python в представление на языке Go и позволяет бесшовно запускать Python-программы в runtime-окружении Go. Проект избавляет от проблемы глобальной блокировки интерпретатора, не допускающей параллельного выполнения нескольких нитей кода.
- Транспиляторы языков ассемблера для различных архитектур или под разные процессоры из одной системы архитектур (например, между 16-битным Intel 8086 и 8-битным Intel 8080).

## Итого

В мире, где есть огромное количество языков программирования, а сами языки имеют множество версий, транспилеры выполняют крайне важную работу — повышают удобство разработки. Разработчики могут писать код на языке или версии языка, которая удобна им или имеет нужные функции, а транспилеры выполнят работу по доставке этого кода до среды исполнения в нужном виде.

На данный момент реализовано множество различных странспилеров (Babel, Vala, Typescript transpiler, Bridge и другие), каждый из них решает свою задачу по-своему, но общий принцип работы транспилеров похож у всех.

![transpilers, scheme](/assets/images/transpilers/scheme.png)

Исходный код парсится в абстрактное синтаксическое дерево, далее AST трансформируется в структуру, которая соотносится с конечным кодом, и из этой структуры генерируется конечный код.

## Дополнительные материалы

- [Сайт для построения AST](https://astexplorer.net/)
