---
title: Что такое SQL-инъекция
description: |
  Вводная информация об одной из известнейших уязвимостей

# image: "/assets/images/bootstrap/bootstrap.jpeg"
author: Александр Коростелин
---

SQL-инъекция - калька с англ. SQL injection (сокр. SQLi), что может быть переведено как "внедрение SQL". 
Суть атаки заключается во внедрении произвольных команд в легитимный запрос к веб-серверу. Если данный сервер уязвим (т.е. не вполне корректным образом обрабатывает запросы), такие команды могут быть выполнены, что, в свою очередь, может привести к несанкционированным раскрытию или модификации данных, хранящихся на сервере.

Давайте рассмотрим процесс немного более развёрнуто. 
Как мы, предположительно, знаем, веб-приложение состоит из клиентской части, реализующей пользовательский интерфейс, и серверной части, хранящей данные. Клиент отправляет некоторый запрос на сервер, а сервер обрабатывает полученный запрос, формирует веб-страницу на основе имеющейся у себя информации, и отправляет её клиенту в ответ. 
Хранилищем информации на сервере, как правило, выступает та или иная база данных. 
Соответственно, мы можем представить следующую схему взаимодействий: веб-сервер получает запрос от клиента, на основе которого формирует запрос к движку БД, движок БД выполняет этот запрос и отдаёт некоторую информацию, веб-сервер её обрабатывает и отдаёт клиенту. 

Конечно же, в реальности клиент запрашивает не какую-то произвольную информацию от сервера, а определённую конкретным параметром – логином пользователя, идентификатором страницы, и т.п. И именно здесь скрывается уязвимость – параметр запроса может содержать некоторую команду, которая может быть распознана и исполнена движком БД. 
Подробности процесса для нас, на самом деле, сейчас не сильно важны; главное, что требуется понимать - отправленный веб-серверу запрос в конечном итоге вызовет исполнение движком БД некоторых команд, причём, в этих командах с высокой долей вероятности будет включена информация, переданная в параметрах изначального запроса. 

Разумеется, коль скоро мы говорим о реляционных базах данных (а их до сих пор в вебе большинство), то и команды движку БД будут составлены на языке запросов SQL, что и даёт название рассматриваемому классу атак. Впрочем, существуют и другие типы инъекций, имеющих родственную природу: NoSQL injection, ORM injection, shell injection и пр.

Атака типа инъекции не нова – на самом деле, они известны с тех самых пор, когда статичные HTML-страницы сайтов стали вытесняться интерактивным контентом (а это произошло ещё в конце 90-х). Классические SQL-инъекции встречаются всё реже, поскольку современные веб-фреймворки обычно имеют встроенные механизмы защиты. 
Тем не менее, уязвимые приложения существуют, и подверженность данному типу атак являет собой критическую уязвимость системы. Внедрение вредоносного кода занимает третье место в списке наиболее критичных уязвимостей веб-приложений [OWASP Top Ten](https://owasp.org/www-project-top-ten/).

## Пример SQL injection

Рассмотрим простейший пример. Вряд ли он встретится в реальной жизни, но достаточен для иллюстрации. Предположим, мы имеем дело с некоторым приложением, среди функционала которого присутствует выборка из БД заказов, отправляемых в определённый город, название которого передаётся параметром GET-запроса: 

```
http://vulnerable.com/something/orders?view=London
```

И на стороне сервера выполняется следующий запрос к БД:

```sql
SELECT * FROM orders WHERE destination = 'London'
```

Где название города подставляется напрямую из параметра запроса веб-клиента.


Теперь предположим, что клиент изменил название города с London на:

```
London'; drop table orders -- 
```

И тогда на стороне сервера выполняется следующий запрос к БД:

```sql
SELECT * FROM orders WHERE destination = 'London'; drop table orders -- '
```

В языке SQL, точка с запятой отделяет один запрос от другого, а пробел и двойной дефис означают начало комментария. Таким образом, данная строка может быть представлена в виде двух последовательных запросов:

```sql
SELECT * FROM orders WHERE destination = 'London'
DROP TABLE orders
```

И после их выполнения таблица с информацией о заказах будет удалена из БД. Больше примеров разных типов SQL-инъекций можно посмотреть, в частности, на сайте [W3C](https://www.w3schools.com/sql/sql_injection.asp).

## Способы защиты

С точки зрения разработчика приложения, можно выделить два основных способа защиты от инъекций:
1.	Не передавать пользовательский ввод движку БД. Конструировать запрос, содержащий переданные извне параметры, следует при помощи специально предназначенных механизмов создания параметризованных запросов. Например, для C# используется свойство Parameters класса SqlCommand. Посмотреть примеры для разных языков можно в [OWASP Query Parameterization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html).
2.	Не доверять пользовательскому вводу. Многоуровневая валидация (проверка параметров на соответствие типу, размеру, формату, граничным значениям), при необходимости удаление специальных и управляющих символов, Escape-последовательностей, поиск и удаление фрагментов команд в строковых запросах.

Также полезно максимально возможное ограничение прав учетных записей на сервере, используемых для работы с БД, и ограничение выдаваемой «наружу» информации в случае возникновения ошибок и сбоев. 

## Способы аудита

Простейшим способом обнаружения SQL-инъекций является подстановка специальных символов (напр. одиночной кавычки, точка с запятой, бэкслэш и пр.) в поля пользовательского ввода, и анализ поведения веб-сервера. 

Существуют и автоматизированные инструменты, например [SQLMap](https://sqlmap.org/), [jSQL Injection](https://www.kali.org/tools/jsql/), NoSQLMap для NoSQL БД. Обширная информация по тестированию включена в состав OWASP Web Security Testing Guide [WSTG-INPV-05]( https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/05-Testing_for_SQL_Injection.html)
.

## Дополнительная информация

- Описание атаки на сайте [OWASP](https://owasp.org/www-community/attacks/SQL_Injection) и [Лаборатории Касперского](https://www.kaspersky.ru/resource-center/definitions/sql-injection)
- Информация от [Microsoft](https://learn.microsoft.com/en-us/sql/relational-databases/security/sql-injection?view=sql-server-ver15) и [PHP Group](https://www.php.net/manual/ru/security.database.sql-injection.php)
