---
layout: post
title: Как и для чего использовать Docker
subtitle: Подзаголовок (выводится на странице поста)
summary: Короткое описание (выводится на главной странице)
cover_url: "Путь к файлу-обложке для соц. сетей, например, /images/vscode_eslint.png"
---

**Docker - программа позволяющая запускать процессы операционной системе в изолированном окружении на базе специально созданных образов. Несмотря на то что технологии лежащие в основа докера появились до него, именно докер произвел революцию в том как сегодня создается инфраструктура проектов, собираются и запускаются сервисы.**

Данный гайд состоит из четырех частей. В первой устанавливается и запускается докер. Во второй объясняется его суть и польза, а так же варианты использования. В третьей описывается внутреннее устройство. В четвертой описываются некоторые из его дополнительных возможностей. Несмотря на все это, невозможно в рамках одного руководство описать все то, что умеет делать докер. За конкретными рецептами и более подробными описаниями обращайтесь к официальной документации.

```
В статье намеренно опущены многие детали, чтобы не грузить информацией, которая не нужна для ознакомления.
```

### Установка

Докер поставляется в виде Community Edition (CE) и Enterprise Edition (EE). Нас интересует CE. На [главной странице](https://www.docker.com/community-edition) этой версии доступны ссылки для скачивания под все популярные платформы. Выберите вашу и установите докер.

В работе докера есть одна деталь, которую важно знать при установке на Mac и Linux. По умолчанию, докер работает через unix сокет. В целях безопасности, сокет закрыт для пользователей не входящих в группу _docker_. И хотя установщик добавлет текущего пользователя в эту группу автоматически, докер сразу не заработает. Дело в том, что если пользователь меняет группу сам себе, то ничего не изменится до тех пор пока пользователь не перелогинится. Такова особенность работы ядра. Для проверки того в какие группы входит ваш пользователь, можно набрать команду `id`.

Проверить успешность установки можно командой `docker info`:

```sh
$ docker info
Containers: 22
 Running: 2
 Paused: 0
 Stopped: 20
Images: 72
Server Version: 17.12.0-ce
Storage Driver: overlay2
 Backing Filesystem: extfs
 Supports d_type: true
 Native Overlay Diff: true
Logging Driver: json-file
Cgroup Driver: cgroupfs
...
```

Она выдает довольно много информации о конфигурации самого докера так и статистику работы.

### Запуск

Начнем с самого простого варианта:

```sh
$ docker run -it nginx bash
root@a6c26812d23b:/#
```

При первом вызове, данная команда начнет скачивать образ (image) _nginx_, поэтому придется немного подождать. После того как образ скачается, запустится _bash_ и вы окажетесь внутри контейнера (container). Побродите по файловой системе, посмотрите папку `/etc/nginx`. Все что вы сделаете здесь внутри, никак не затронет вашу основную файловую систему. Вернуться в родные скрепы можно командой `exit`. Теперь посмотрим вариант вызова команды `cat`:

```sh
$ docker run nginx cat /etc/nginx/nginx.conf
...
$
```

Эта команда запускается практически мгновенно, так как образ уже загружен. В отличие от предыдущего старта, где запускается баш и начинается интерактивная сессия, запуск команды `cat /etc/nginx/nginx.conf` для образа _nginx_ выведет на экран содержимое указанного файла и вернет управление в то место где вы были. Вы не окажетесь внутри контейнера.

Последний вариант запуска будет таким:

```sh
$ docker run -p 8080:80 nginx
```

Данная команда не возвращает управление потому что стартует Nginx. Откройте браузер и наберите `localhost:8080`. Вы увидите как загрузилась страница _Welcome to nginx!_. Если в этот момент снова посмотреть в консоль где был запущен контейнер, то можно увидеть что туда выводится лог запросов к `localhost:8080`. Остановить Nginx можно командой <kbd>Ctrl + C</kbd>

Несмотря на то что все запуска выполнялись по разному и приводили к разным результатам, общая схема их работы - одна и та же. Докер при необходимости автоматически скачивает образ (первый аргумент после `docker run`) и на основе него стартует контейнер с указанной командой.

Образ - слепок файловой системы
Контейнер - запущенный процесс операционной системы в изолированном окружении с подключенной файловой системой из образа.

Повторюсь что контейнер всего лишь обычный процесс вашей операционной системы. Разница лишь в том, что благодаря возможностям ядра (о них в конце) докер стартует процесс в изолированном окружении. Контейнер видит свой собственный список процессов, свою собственную сеть, свою собственную файловую систему и так далее. Пока ему не укажут явно, он не может взаимодействовать с вашей основной операционной системой и всем что в ней хранится или запущено.

Попробуйте выполнить команду `docker run -it ubuntu bash` и наберите `ps auxf`. Вывод будет таким:

```sh
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  0.1  18240  3300 pts/0    Ss   15:39   0:00 /bin/bash
root        12  0.0  0.1  34424  2808 pts/0    R+   15:40   0:00 ps aux
```

То есть видно что процесса всего два и у Bash PID равен 1. Заодно можно посмотреть в папку `/home` командой `ls /home` и убедиться что она пустая.

### Зачем все это?

Докер можно использовать для разных целей. Самая простая - доставка софта. Вспомните когда вам приходилось собирать программы из исходников. Этот процесс включает в себя следующие шаги:

* Установить все необходимые зависимости под вашу операционную систему (их список еще надо найти)
* Скачать архив, распаковать
* Запустить конфигурирование `make configure`
* Запустить компиляцию `make compile`
* Установить `make install`

Как видите, процесс нетривиальный и далеко не всегда быстрый. Иногда даже невыполнимый. И это не говоря про загрязнение операционной системы.

Докер позволяет упростить эту процедуру до запуска одной команды причем с почти 100% гарантией успеха. Посмотрите на настоящий пример:

```sh
```

Запуск команды выше приводит к тому в основной системе, в папке `...` оказывается исполняемый файл программы LALA, которая была скомпилирована на локальном компьютере, но внутри запущенного контейнера. Теперь LALA запускается без докера командой `ehu`. Весь фокус в том, что образ, из которого был запущен контейнер, подготовлен программистами разрабатывающими LALA. Внутри него установлены все необходимые зависимости и его запуск практически гарантирует 100% работоспособность независимо от вашей основной ОС.

Часто даже не обязательно копировать программу из контейнера на вашу основную систему. Достаточно запускать сам контейнер когда в этом возникнет необходимость. Предположим что мы решили разработать статический сайт на основе Jekyll. Jekyll - популярный генератор статических сайтов написанный на руби. Например гайд который вы читаете прямо сейчас, находится на статическом сайте сгенерированном с помощью Jekyll. И при его генерации использовался докер (об этом можно прочитать в гайде: [как делать блог на Jekyll](http://guides.hexlet.io/jekyll/)).

Старый способ использования Jekyll требовал установки на вашу основную систему как минимум ruby и самого Jekyll в виде гема (название пакетов в ruby). Причем, как и всегда, в подобных вещах, Jekyll работает только с определенными версиями руби, что вносит свои проблемы при настройке. С докером, запуск Jekyll сводится к одной команде, выполняемой в папке с блогом (Подробнее можно посмотреть в [репозитории](https://github.com/hexletguides/hexletguides.github.io) наших гайдов):

```sh
docker run --rm --volume="$PWD:/srv/jekyll" -it jekyll/jekyll jekyll server
```

Точно таким же образом сейчас запускается огромное количество различного софта. Чем дальше, тем больше подобный способ захватывает мир. На этом месте можно немного окунуться в происхождение названия Docker.

![](картинка)

Как вы знаете, основной способ распространения товаров по миру - корабли. Раньше стоимость перевозки была довольно большая, по причине того, что каждый груз имел собственную форму и тип материала. Загрузить на корабль мешок с рыбой или машину - две большие разницы. Возникали проблемы со способами погрузки требовавшими разнообразные краны и инструменты. С другой стороны, эффективно упаковать груз на самом корабле, тоже не тривиальная задача.


Но в какой-то момент все изменилось. Картинка стоит тысячи слов:

![](картинка)

Контейнеры уровняли все виды грузов. Что в свою очередь привело к упрощению процессов, ускорению и следовательно удешевлению.

Ровно тоже самое произошло и в разработке. Docker стал универсальным средством доставки софта независимо от его структуры, зависимостей и способа установки. Все что нужно программам, распространяемым через докер, находится внутри образа и не пересекается с основной системой и другими контейнерами. Важность этого факта невозможно переоценить. Теперь обновление версий программ никак не задействует ни саму систему, ни другие программы. Сломаться больше ничего не может. Все что нужно сделать это скачать новый образ той программы, которую требуется обновить. Другими словами, докер убрал проблему [dependency hell](https://ru.wikipedia.org/wiki/Dependency_hell) и сделал инфраструктуру [immutable](https://martinfowler.com/bliki/ImmutableServer.html) (неизменяемой).

---

*Кирилл Мокевнин*
